Для сохранения спецификации в формате PDF, выполните следующие действия:

1. Выделите текст ниже (включая изображения).
2. Щелкните правой кнопкой мыши.
3. Выберите "Печать" (Print).
4. Выберите "Сохранить как PDF" (Save as PDF).

[Вернуться на страницу проекта Time Appliances (Time Appliance Project)](https://www.opencompute.org/wiki/Time_Appliance_Project)
# Открытый временной сервер
#### Спецификация, версия № 1.0
Открытый временной сервер (OTS) - это открытая, масштабируемая и проверенная архитектура, которая может быть развернута в центрах обработки данных или на периферийных устройствах.
Эту спецификацию можно найти по адресу http://www.opentimeserver.com

![Логотип GitHub](https://github.com/opencomputeproject/Time-Appliance-Project/blob/master/Time-Card/images/OCP%20logo.jpg?raw=true)

## Содержание
1. [Список изображений](#Список-изображений)
2. [Сокращения](#Сокращения)
3. [Общее](#Общее)
4. [Архитектура высокого уровня](#Архитектура-высокого-уровня)
   1. [Обязанности и требования](#Обязанности-и-требования)
      1. [COTS-сервер](#COTS-сервер)
      1. [Сетевая сетевая карта (NIC)](#Сетевая-сетевая-карта-(NIC))
      1. [Временная карта (Time Card)](#Временная-карта-(Time-Card))
5. [Подробная архитектура](#Подробная-архитектура)
   1. [COTS-сервер](#COTS-сервер-1)
      1. [Аппаратное обеспечение](#Аппаратное-обеспечение)
      1. [Программное обеспечение](#Программное-обеспечение)
   1. [Сетевая сетевая карта (NIC)](#Сетевая-сетевая-карта-(NIC)-1)
      1. [Форм-фактор](#Форм-фактор)
      1. [Интерфейс PCIe](#Интерфейс-PCIe)
      1. [Сетевые порты](#Сетевые-порты)
      1. [Аппаратные метки времени](#Аппаратные-метки-времени)
      1. [PPS вход (вывод)](#PPS-вход-(вывод))
   1. [Временная карта (Time Card)](#Временная-карта-(Time-Card)-1)
6. [Лицензия](#Лицензия)

## Список изображений
Список изображений | Описание
------------ | -------------
[Рисунок 1](#figure-1) | Диаграмма системы открытого временного сервера
[Рисунок 2](#figure-2) | Концепция открытого временного сервера
[Рисунок 3](#figure-3) | Сборка открытого временного сервера

## Сокращения
Сокращение | Описание
------------ | -------------
AC | Атомные часы (Atomic Clock)
COTS | Готовое к использованию с оборудованием (Commodity off-the-shelf)
DC | Центр обработки данных (Datacenter)
GNSS | Глобальная навигационная спутниковая система (Global Navigation Satellite System)
GTM | Старт продаж на рынок (Go-To-Market)
HW | Аппаратное обеспечение (Hardware)
NIC | Сетевая сетевая карта (Network Interface Card)
NTP | Сетевой протокол времени (Network Time Protocol)
OCP | Проект Open Compute (Open Compute Project)
OCXO | Овен-контролируемый осциллятор (Oven-Controlled Oscillator)
OTS | Открытый временной сервер (ранее известный как **Open Grandmaster** или **Leader**)
PHC | Аппаратные часы PTP (PTP Hardware Clock)
PPS | Импульсы в секунду (Pulse-Per-Second)
PTM | Точные измерения времени (Precision Time Measurements)
PTP | Протокол точного времени (Precision Time Protocol)
SW | Программное обеспечение (Software)
TAP | Проект временного устройства (Time Appliance Project)
TCXO | Температуроустойчивый осциллятор с компенсацией температуры (Temperature-compensated Oscillator)
ToD | Время дня (Time of Day)
TS | Метка времени (Timestamp)
XO | Осциллятор (Oscillator)

Таблица 1. Сокращения

# Общее
[OCP TAP](https://www.opencompute.org/wiki/Time_Appliances_Project) нацелен на упрощение добавления синхронизации времени в качестве сервиса в центры обработки данных. Основные цели проекта - определение требований к сервису, развертывание и проектирование открытого эталонного дизайна.

Сервис синхронизации времени базируется на технологии синхронизации, и на данный момент мы используем PTP (IEEE 1588) с некоторыми дополнениями и NTP.

Архитектура

 PTP масштабируется и определяет источник времени сущности, называемой **часами времени сервера** (или слоем 1 в терминах NTP). Открытый временной сервер распространяет время по всей сети и обычно получает свое время из внешнего источника (сигнала GNSS).

Существующие реализации открытых временных серверов имеют несколько недостатков, которые мы хотим учесть:

* Это аппаратное оборудование, обычно ориентированное на другой рынок, чем центры обработки данных.
* Они предоставляют нестандартные и несовместимые интерфейсы и наборы функций программного обеспечения.
* Циклы разработки и усилия, необходимые для добавления новых функций, являются долгими и дорогостоящими.
* Они не используют программное обеспечение с открытым исходным кодом.
* Точность и стабильность не соответствуют требованиям центров обработки данных.

# Архитектура высокого уровня
В целом, OTS делится на 3 аппаратных компонента:

1. COTS-сервер
2. Сетевая сетевая карта (NIC)
3. Временная карта (Time Card)

<a id="Рисунок-1">![Диаграмма системы открытого временного сервера](/Time-Card/images/overall.png)</a>
<p align="center">Рисунок 1. Диаграмма системы открытого временного сервера</p>

Философия, лежащая в основе этой фрагментации, является очень ясной, и каждое решение, модификация, которое будет принято, должно соответствовать этой философии:

* COTS-серверы сохраняют свою "ценность за деньги" благодаря большому спросу на рынке. Они обычно обновляются с последней версией ОС, обновлениями безопасности и новыми технологиями, быстрее, чем аппаратное оборудование.
* Современные сетевые сетевые карты уже поддерживают аппаратные метки времени, лидируют на рынке с Ethernet и самыми последними скоростями и функциональностью PCIe. Современные сетевые карты также поддерживают широкий спектр версий ОС и поставляются с отличной экосистемой программного обеспечения. Сетевая карта + COTS-сервер позволит OTS выполнять полный стек программного обеспечения PTP и NTP (включая открытое программное обеспечение).
* Временная карта будет самой маленькой (концептуально) платой аппаратного оборудования, которая предоставит входной сигнал GNSS и стабильный частотный вход. Изолирование этих функций на временной карте позволит OTS выбирать подходящую временную карту для своих потребностей (точность, стабильность, стоимость и т. д.) и оставаться при том же программном обеспечении, интерфейсе и архитектуре.

<a id="Рисунок-2">![Концепция открытого временного сервера](/Time-Card/images/OTS_concept.png)</a>
<p align="center">Рисунок 2. Концепция открытого временного сервера</p>

Основная идея заключается в том, что временная карта подключается через интерфейс PCIe к серверу и предоставляет время суток (ToD) через интерфейс `/dev/ptpX`. С использованием этого интерфейса `phc2sys` непрерывно синхронизирует PHC на сетевой карте с атомными часами на временной карте. Это обеспечивает точность менее 1 мкс.

Для достижения крайне высокой точности 1PPS выход временной карты должен быть подключен к 1PPS входу сетевой сетевой карты, обеспечивая точность менее 100 нс.

## Обязанности и требования
### COTS-сервер
* Запуск коммерческой ОС
* Интерфейс PCIe
* [необязательно] Поддержка PTM
#### Сетевая сетевая карта (NIC)
* Аппаратные метки времени
* [необязательно] PPS вход/выход
* [необязательно] Поддержка PTM
* [необязательно] Передача времени суток от временной карты к ПО
#### Временная карта (Time Card)
* Задержка (Holdover)
* Вход GNSS
* PPS вход/выход
* Учет секунды в случае вставки (Leap second awareness)
* Время суток
* [необязательно] Поддержка PTM

# Подробная архитектура
Компоненты сборки в реальной жизни могут быть

<a id="Рисунок-3">![Сборка

 открытого временного сервера](/Time-Card/images/OTS_assembly.jpeg)</a>
<p align="center">Рисунок 3. Сборка открытого временного сервера</p>

## COTS-сервер
### Аппаратное обеспечение
Можно использовать большую часть оборудования общего назначения.
Требуется поддержка процессоров vt-d.
Если выбрана многопроцессорная система, рекомендуется подключить временную карту и сетевую сетевую карту к одной и той же линии PCIe. Синхронизация между несколькими процессорами добавит дополнительное смещение.

Мы протестировали и подтвердили, что установка работает со следующей спецификацией платформы:
* HPE ProLiant DL380 Gen10
* OCP Tioga Pass
* SuperMicro 6019U-TRT - однопроцессорная или двухпроцессорная
* SuperMicro 5019GP-TT - однопроцессорная с максимальной пропускной способностью
* Intel NUC 9 Pro

### Программное обеспечение
Пожалуйста, подробное описание [программного обеспечения](https://github.com/opencomputeproject/Time-Appliance-Project/tree/master/Software) документа
* Операционная система Linux с драйвером [ocp_ptp](https://github.com/opencomputeproject/Time-Appliance-Project/tree/master/Time-Card/DRV) (включенным в ядро Linux 5.12 и более новое). Драйвер может потребовать включения флага vt-d CPU в BIOS.
* Сервер NTP - [Chrony](https://github.com/mlichvar/chrony)/NTPd, считывающий `/dev/ptpX` с временной карты.
* Сервер PTP - [ptp4u](https://github.com/facebook/time) или [ptp4l](https://github.com/richardcochran/linuxptp), считывающий `/dev/ptpX` с сетевой сетевой карты.
  * [phc2sys](https://github.com/richardcochran/linuxptp)/[ts2phc](https://github.com/richardcochran/linuxptp) для копирования значений часов с временной карты на сетевую сетевую карту
## Сетевая сетевая карта (NIC)
Большую часть оборудования общего назначения можно использовать.
Для улучшения точности NTP или PTP могут потребоваться дополнительные требования ниже.

### Форм-фактор
* Стандартное PCIe Stand-up HHHL Half-Height, Half-Length -или- [OCP NIC 3.0](https://www.opencompute.org/wiki/Server/Mezz)
* Одно слот - Пассивное охлаждение
* Поддержка стандартных PCIe для высоких и коротких кронштейнов -или- типов выбрасывателя OCP NIC 3.0

### Интерфейс PCIe
* PCIe Gen3.0/Gen4.0 X n линий на золотых контактах, где n = как минимум 8

### Сетевые порты
* Однопортовый или двухпортовый Ethernet

### Аппаратные метки времени
Сетевая сетевая карта должна выполнять метки времени для всех входящих пакетов.  
Пакеты без PTP меток могут быть объединены и иметь общие метки времени в дескрипторе ПО, пока они не находятся на расстоянии более TBD наносекунд.  
Сетевая сетевая карта должна выполнять метки времени для всех исходящих пакетов PPS.

* PHC
* PTM
* Вход 1PPS
* [необязательно] Вход 10 МГц, который можно использовать в качестве входа частоты для устройства TSU
* [необязательно] Поддержка мультихост

### Вывод PPS
* Подъем/спад PPS Out < 5 нс
* Задержка PPS Out < 400 пс
* Дрожание PPS Out < 250 фемтосекунд
* Сопротивление PPS Out = 50 Ом
* Частота PPS Out 1 Гц - 10 МГц

### Вход PPS
* Задержка входа PPS In < 400 пс
* Дрожание входа PPS In < 250 фемтосекунд
* Сопротивление входа PPS In = 50 Ом
* Частота входа PPS In 1 Гц - 10 МГц

Примеры:
* [NVIDIA ConnectX-6 Dx](https://www.mellanox.com/products/ethernet-adapters/connectx-6-dx)

## Временная карта (Time Card)
Пожалуйста, ознакомьтесь с [подробной архитектурой временной карты](https://github.com/opencomputeproject/Time-Appliance-Project/tree/master/Time-Card) или просто посетите www.timingcard.com.

Основная идея заключается в том, что эта карта подключается через интерфейс PCIe к серверу и предоставляет время суток (ToD) через интерфейс `/dev/ptpX`. С использованием этого интерфейса `phc2sys` непрерывно син

хронизирует PHC на сетевой карте с атомными часами на временной карте. Это обеспечивает точность менее 1 мкс.

Для достижения крайне высокой точности 1PPS выход временной карты должен быть подключен к 1PPS входу сетевой сетевой карты, обеспечивая точность менее 100 нс. Цена точности на входе PPS временной карты состоит в том, что она берет опорный сигнал от атомных часов (по умолчанию).

[Схема подключения](/Time-Card/images/OTS_Connect.png)

Примечание: Чтобы добиться максимальной точности, важно учесть задержку в соединительных кабелях между временной картой и сетевой сетевой картой. В идеале, кабель не должен иметь задержки, но на практике это невозможно. Необходимо минимизировать длину и задержку кабелей и их влияние на точность синхронизации.

# Лицензия
Лицензия OCP применяется к этому проекту, см. Страницу проекта Time Appliance [на сайте OCP](https://www.opencompute.org/wiki/Time_Appliances_Project).

---

Это спецификация открытого временного сервера версии 1.0. Для более подробной информации и последних обновлений следуйте по [ссылке](https://www.opencompute.org/wiki/Time_Appliance_Project).

Чтобы сохранить эту спецификацию в формате PDF, выполните указанные выше действия.